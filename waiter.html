<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ospătar - Gestionare Mese</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-color: #111827;
      color: #fff;
      font-family: Arial, sans-serif;
      margin: 0; 
      padding: 1rem;
      min-height: 100vh;
    }
    .btn {
      background-color: #f49032;
      padding: 8px 16px;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      border: none;
    }
    .btn:hover {
      background-color: #d35400;
    }
    .table-box {
      border: 1px solid #f49032;
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 6px;
    }
    .order-box {
      border: 1px solid #e78c00;
      padding: 0.5rem;
      margin-bottom: 1rem;
      border-radius: 6px;
    }
    .order-item {
      margin-left: 1rem;
    }
  </style>
</head>
<body>
  <h1 class="text-2xl font-bold mb-4 text-center">Aplicație Ospătar - Gestionare Mese</h1>

  <div id="app" class="max-w-3xl mx-auto">
    <!-- Buton: Vezi Mesele "occupied" -->
    <div class="mb-4">
      <button class="btn" @click="fetchOccupiedTables">Vezi Mesele Ocupate</button>
    </div>

    <!-- Lista meselor cu status="occupied" -->
    <div v-if="occupiedTables.length > 0">
      <h2 class="text-xl font-bold mb-2">Mese Ocupate:</h2>
      <div
        v-for="(tbl, idx) in occupiedTables"
        :key="tbl.tableId"
        class="table-box"
      >
        <div class="flex justify-between items-center">
          <div>
            <strong>{{ tbl.tableId }}</strong>
            <br/>
            <em>Cod sesiune: {{ tbl.sessionCode }}</em>
          </div>
          <!-- Ospătarul introduce codul -->
          <button class="btn" @click="askForCode(tbl.tableId, tbl.sessionCode)">
            Deblochează Masa
          </button>
        </div>
      </div>
    </div>
    <div v-else class="text-gray-400 mb-4">
      Nu există mese cu status="occupied".
    </div>

    <hr class="my-4 border-gray-700"/>

    <!-- Comenzile mesei curente (dacă e "active") -->
    <div v-if="currentTableId" class="table-box">
      <h2 class="text-xl font-bold mb-2">
        Masă: {{ currentTableId }} (status = {{ currentStatus }})
      </h2>
      <div v-if="orders.length === 0" class="italic mt-2">
        Nu există comenzi salvate (closed / open) pentru această masă.
      </div>
      <div v-else>
        <div
          v-for="(ord, idx) in orders"
          :key="ord.docId"
          class="order-box"
        >
          <div class="font-bold mb-2">
            Comanda #{{ ord.docId }}  
            (Client #{{ ord.clientNumber }}) - <em>{{ ord.status }}</em>
          </div>
          <ul class="order-item text-gray-200">
            <li
              v-for="(item, iidx) in ord.items"
              :key="iidx"
            >
              {{ item.name }} x {{ item.quantity }} – {{ (item.price * item.quantity).toFixed(2) }} Lei
            </li>
          </ul>
          <div class="font-bold mt-1 text-[#f49032]">
            Subtotal: {{ ord.total.toFixed(2) }} Lei
          </div>
          <!-- Buton "Comanda Plasată" doar pentru status="open" && placedByWaiter=false -->
          <div class="mt-2">
            <button
              v-if="ord.status === 'open' && !ord.placedByWaiter"
              class="btn"
              @click="markOrderAsPlaced(ord.docId)"
            >
              Comanda Plasată
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase + Vue (ES module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      updateDoc,
      getDocs,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
    import { createApp } from "https://cdn.jsdelivr.net/npm/vue@3/dist/vue.esm-browser.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBahkhy2GgUW2wM5dxghoVt2bv0-6ZyWqQ",
      authDomain: "restaurantapp-d0256.firebaseapp.com",
      projectId: "restaurantapp-d0256",
      storageBucket: "restaurantapp-d0256.firebasestorage.app",
      messagingSenderId: "275208346650",
      appId: "1:275208346650:web:f262b8ec49242d4b9945a3",
      measurementId: "G-F44TB27G17"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const waiterApp = createApp({
      data() {
        return {
          occupiedTables: [], // Mese cu status="occupied"
          currentTableId: "",
          currentSessionCode: "",
          currentStatus: "",
          orders: []
        };
      },
      methods: {
        // Preluăm mesele care au status="occupied"
        async fetchOccupiedTables() {
          try {
            const cRef = collection(db, "sessions");
            const qRef = query(cRef, where("status", "==", "occupied"));
            const snap = await getDocs(qRef);

            this.occupiedTables = [];
            snap.forEach(docSnap => {
              const data = docSnap.data();
              this.occupiedTables.push({
                tableId: docSnap.id,        // ex. "Masa-1"
                sessionCode: data.sessionCode
              });
            });
          } catch (e) {
            console.error("Eroare la fetchOccupiedTables:", e);
            alert("Eroare la încărcarea meselor!");
          }
        },

        // Ospătarul introduce codul => devine "active"
        async askForCode(tableId, realCode) {
          const userInput = prompt(`Introdu codul de sesiune pentru ${tableId}:`);
          if (!userInput) return;

          if (userInput.trim() === realCode) {
            try {
              // Deblocăm masa
              const docRef_ = doc(db, "sessions", tableId);
              await updateDoc(docRef_, { status: "active" }); 
              alert(`Masa ${tableId} a fost deblocată!`);

              this.currentTableId = tableId;
              this.currentSessionCode = realCode;
              this.currentStatus = "active";

              // Încărcăm comenzile "open" sau "closed" care au același sessionCode
              await this.loadOrdersBySession(realCode);
            } catch (err) {
              console.error("Eroare la deblocare masă:", err);
              alert("Nu s-a putut debloca masa!");
            }
          } else {
            alert("Cod de sesiune greșit!");
          }
        },

        async loadOrdersBySession(sCode) {
          this.orders = [];
          try {
            const cRef = collection(db, "orders");
            const qRef = query(cRef, where("sessionCode", "==", sCode));
            const snap = await getDocs(qRef);

            snap.forEach(docSnap => {
              const data = docSnap.data();
              data.docId = docSnap.id;
              this.orders.push(data);
            });
          } catch (e) {
            console.error("Eroare la loadOrdersBySession:", e);
            alert("Eroare la încărcarea comenzilor!");
          }
        },

        // Marchează comanda ca plasată
        async markOrderAsPlaced(orderId) {
          try {
            const docRef_ = doc(db, "orders", orderId);
            await updateDoc(docRef_, { placedByWaiter: true });
            const orderIndex = this.orders.findIndex(o => o.docId === orderId);
            if (orderIndex !== -1) {
              this.orders[orderIndex].placedByWaiter = true;
            }
            alert("Comanda a fost marcată ca plasată!");
          } catch (err) {
            console.error("Eroare la markOrderAsPlaced:", err);
            alert("Nu s-a putut marca această comandă!");
          }
        }
      }
    });

    waiterApp.mount('#app');
  </script>
</body>
</html>
